{
  "instance_id": "django__django-14792",
  "status": "completed",
  "patch": "diff --git a/django/db/backends/mysql/operations.py b/django/db/backends/mysql/operations.py\nindex 89730cee29..3a8bd109e2 100644\n--- a/django/db/backends/mysql/operations.py\n+++ b/django/db/backends/mysql/operations.py\n@@ -76,10 +76,14 @@ class DatabaseOperations(BaseDatabaseOperations):\n             return \"DATE(%s)\" % (field_name)\n \n     def _prepare_tzname_delta(self, tzname):\n-        if '+' in tzname:\n-            return tzname[tzname.find('+'):]\n-        elif '-' in tzname:\n-            return tzname[tzname.find('-'):]\n+        if tzname.startswith('+'):\n+            return tzname\n+        elif tzname.startswith('-'):\n+            return tzname\n+        elif tzname.startswith('UTC+'):\n+            return '+' + tzname[4:]\n+        elif tzname.startswith('UTC-'):\n+            return '-' + tzname[4:]\n         return tzname\n \n     def _convert_field_to_tz(self, field_name, tzname):\ndiff --git a/django/db/backends/oracle/operations.py b/django/db/backends/oracle/operations.py\nindex 4cfc7da070..efaf2ec39e 100644\n--- a/django/db/backends/oracle/operations.py\n+++ b/django/db/backends/oracle/operations.py\n@@ -108,10 +108,14 @@ END;\n     _tzname_re = _lazy_re_compile(r'^[\\w/:+-]+$')\n \n     def _prepare_tzname_delta(self, tzname):\n-        if '+' in tzname:\n-            return tzname[tzname.find('+'):]\n-        elif '-' in tzname:\n-            return tzname[tzname.find('-'):]\n+        if tzname.startswith('+'):\n+            return tzname\n+        elif tzname.startswith('-'):\n+            return tzname\n+        elif tzname.startswith('UTC+'):\n+            return '+' + tzname[4:]\n+        elif tzname.startswith('UTC-'):\n+            return '-' + tzname[4:]\n         return tzname\n \n     def _convert_field_to_tz(self, field_name, tzname):\ndiff --git a/django/db/backends/postgresql/operations.py b/django/db/backends/postgresql/operations.py\nindex 8d19872bea..a6d44ff774 100644\n--- a/django/db/backends/postgresql/operations.py\n+++ b/django/db/backends/postgresql/operations.py\n@@ -44,10 +44,14 @@ class DatabaseOperations(BaseDatabaseOperations):\n         return \"DATE_TRUNC('%s', %s)\" % (lookup_type, field_name)\n \n     def _prepare_tzname_delta(self, tzname):\n-        if '+' in tzname:\n-            return tzname.replace('+', '-')\n-        elif '-' in tzname:\n-            return tzname.replace('-', '+')\n+        if tzname.startswith('+'):\n+            return '-' + tzname[1:]\n+        elif tzname.startswith('-'):\n+            return '+' + tzname[1:]\n+        elif tzname.startswith('UTC+'):\n+            return 'UTC-' + tzname[4:]\n+        elif tzname.startswith('UTC-'):\n+            return 'UTC+' + tzname[4:]\n         return tzname\n \n     def _convert_field_to_tz(self, field_name, tzname):\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-17T11:43:40.092689",
  "end_time": "2026-01-17T11:57:22.541998",
  "duration_seconds": 822.449309,
  "error_message": null,
  "workspace_path": "./workspaces/django__django-14792",
  "epic_comments": [
    {
      "epic_id": "9e52a436-9e48-4700-b99f-0937d8a85e31",
      "epic_title": "Fix: django__django-14792",
      "comment_id": "f39ec181-73c3-4afb-bac9-6a3f1a7a40e9",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\nFixed the reverse timezone conversion bug in Trunc()/Extract() database functions by modifying the `_prepare_tzname_delta()` method in PostgreSQL, MySQL, and Oracle backends.\n\n**Root Cause:** In Django 3.2, `_get_timezone_name()` changed to return full timezone names like \"Etc/GMT-10\" instead of just offset strings like \"+10\". The `_prepare_tzname_delta()` functions were incorrectly manipulating timezone names containing '+' or '-' anywhere in the string, instead of only processing offset-style strings that START with '+' or '-'.\n\n**The Fix:** Modified all three backends to only process offset-style timezone strings (those starting with '+' or '-'), and pass named timezones through unchanged to the database.\n\n## Files Modified\n- `django/db/backends/postgresql/operations.py`: Changed `_prepare_tzname_delta()` to only invert signs for offset strings starting with '+' or '-'\n- `django/db/backends/mysql/operations.py`: Changed `_prepare_tzname_delta()` to only process offset strings starting with '+' or '-', passing named timezones unchanged\n- `django/db/backends/oracle/operations.py`: Same fix as MySQL\n\n## Test Results\n- **Test file:** db_functions.datetime.test_extract_trunc\n- **Baseline (before fix):** 87 passed, 2 skipped, 0 errors\n- **After fix:** 87 passed, 2 skipped, 0 errors\n- **Regression check:** No new failures introduced\n\n**Additional tests:**\n- timezones: 84 passed, 8 skipped\n- backends: 256 passed, 88 skipped\n\n## Additional Verification\nVerified the fix logic directly:\n- \"Etc/GMT-10\" now passes through unchanged (previously incorrectly became \"Etc/GMT+10\")\n- \"+10\" still correctly becomes \"-10\" (for PostgreSQL) or stays \"+10\" (for MySQL/Oracle)\n- Named timezones like \"America/New_York\" pass through unchanged\n\n## Concerns\n- None. The fix is minimal and focused, maintaining backward compatibility for offset strings while fixing the issue with named timezones.",
      "created_at": "2026-01-17T10:47:35.812Z"
    },
    {
      "epic_id": "9e52a436-9e48-4700-b99f-0937d8a85e31",
      "epic_title": "Fix: django__django-14792",
      "comment_id": "ce4563e3-1a95-4a83-b85c-f19df2a01db7",
      "author_name": "Code Reviewer",
      "content": "Code Review FAILED\n\nIssues Found:\n- Potential regression for tzinfo values whose `str(tzinfo)` format is `UTC\u00b1HH:MM` (e.g., `datetime.timezone(timedelta(hours=10))` gives `UTC+10:00`).\n  - MySQL/Oracle: `_prepare_tzname_delta()` used to strip this to `+10:00`/`-10:00` via `find('+')/find('-')`; it now returns the full `UTC+10:00` string, which is unlikely to be accepted by `CONVERT_TZ()` / `AT TIME ZONE` as an offset.\n  - PostgreSQL: `_prepare_tzname_delta()` now leaves `UTC+10:00` unchanged (because it doesn\u2019t start with `+`/`-`), but this likely needs the same sign inversion as other offset-style inputs.\n- MySQL/Oracle implementation is now effectively \u201creturn tzname\u201d for all inputs except that it stops slicing named zones like `Etc/GMT-10`. That fixes the reported regression, but it also drops previously-supported offset normalization behavior (see above).\n- Test evidence: you reported passing results, but the \u201cTest file\u201d is listed as `db_functions.datetime.test_extract_trunc` rather than a concrete path/command. Please include the exact pytest invocation and file path in the next update.\n\nRequired Changes:\n- Update `_prepare_tzname_delta()` logic to distinguish:\n  - offset-style strings (including `UTC\u00b1HH:MM`) that should be normalized (and for PostgreSQL, sign-inverted), vs.\n  - named time zones (e.g., `Etc/GMT-10`, `America/New_York`) that must pass through unchanged.\n- Re-run the relevant test module and include the exact command + baseline/after counts.\n",
      "created_at": "2026-01-17T10:51:52.143Z"
    },
    {
      "epic_id": "9e52a436-9e48-4700-b99f-0937d8a85e31",
      "epic_title": "Fix: django__django-14792",
      "comment_id": "7aaccf86-a1ed-4b3e-bcab-19f3f487c531",
      "author_name": "Brainstormer",
      "content": "## Updated Fix Summary (Addressing Code Review Feedback)\n\nAdded handling for `UTC\u00b1HH:MM` format (e.g., `datetime.timezone(timedelta(hours=10))` produces `UTC+10:00`).\n\n### Changes Made\n\n**PostgreSQL (`django/db/backends/postgresql/operations.py:46-55`):**\n```python\ndef _prepare_tzname_delta(self, tzname):\n    if tzname.startswith('+'):\n        return '-' + tzname[1:]\n    elif tzname.startswith('-'):\n        return '+' + tzname[1:]\n    elif tzname.startswith('UTC+'):\n        return 'UTC-' + tzname[4:]\n    elif tzname.startswith('UTC-'):\n        return 'UTC+' + tzname[4:]\n    return tzname\n```\n\n**MySQL/Oracle (`django/db/backends/mysql/operations.py:78-87`, `oracle/operations.py:110-119`):**\n```python\ndef _prepare_tzname_delta(self, tzname):\n    if tzname.startswith('+'):\n        return tzname\n    elif tzname.startswith('-'):\n        return tzname\n    elif tzname.startswith('UTC+'):\n        return '+' + tzname[4:]\n    elif tzname.startswith('UTC-'):\n        return '-' + tzname[4:]\n    return tzname\n```\n\n### Behavior Summary\n\n| Input | PostgreSQL | MySQL/Oracle |\n|-------|------------|--------------|\n| `+10` | `-10` | `+10` |\n| `-05:30` | `+05:30` | `-05:30` |\n| `UTC+10:00` | `UTC-10:00` | `+10:00` |\n| `UTC-05:30` | `UTC+05:30` | `-05:30` |\n| `Etc/GMT-10` | `Etc/GMT-10` | `Etc/GMT-10` |\n| `America/New_York` | `America/New_York` | `America/New_York` |\n\n### Test Results\n\n**Command:** `docker exec -w /testbed swe-bench-django__django-14792 /opt/miniconda3/envs/testbed/bin/python tests/runtests.py db_functions.datetime.test_extract_trunc --verbosity=1`\n\n- **Baseline (before fix):** 87 passed, 2 skipped, 0 errors\n- **After fix:** 87 passed, 2 skipped, 0 errors\n- **No regressions**\n\n**Additional tests:**\n- `timezones` + `backends`: 340 passed, 96 skipped",
      "created_at": "2026-01-17T10:53:30.935Z"
    },
    {
      "epic_id": "9e52a436-9e48-4700-b99f-0937d8a85e31",
      "epic_title": "Fix: django__django-14792",
      "comment_id": "5257b1ae-5f5e-43b0-b766-49aa78d78559",
      "author_name": "Code Reviewer",
      "content": "Code review PASSED. Fix addresses the reported Trunc()/Extract() reverse time zone conversion regression.\n\nNotes:\n- `_prepare_tzname_delta()` now correctly treats IANA zone names like `Etc/GMT-10` as names (no sign flipping) while still handling offset-style strings.\n- Added explicit handling for `datetime.timezone(...)` string forms (`UTC\u00b1HH:MM`), which is exercised by `tests/db_functions/datetime/test_extract_trunc.py`.\n- Test command + baseline/after results were provided and look appropriate.\n",
      "created_at": "2026-01-17T10:57:08.377Z"
    }
  ]
}