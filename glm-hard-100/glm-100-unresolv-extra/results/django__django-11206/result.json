{
  "instance_id": "django__django-11206",
  "status": "completed",
  "patch": "diff --git a/django/utils/numberformat.py b/django/utils/numberformat.py\nindex 88b35fc435..5f0c2dba87 100644\n--- a/django/utils/numberformat.py\n+++ b/django/utils/numberformat.py\n@@ -27,6 +27,13 @@ def format(number, decimal_sep, decimal_pos=None, grouping=0, thousand_sep='',\n     # sign\n     sign = ''\n     if isinstance(number, Decimal):\n+        if decimal_pos is not None:\n+            # If the provided number is too small to affect any of the visible\n+            # decimal places, consider it equal to '0'.\n+            cutoff = Decimal('0.' + '1'.rjust(decimal_pos, '0'))\n+            if abs(number) < cutoff:\n+                number = Decimal(0).copy_sign(number)\n+\n         # Format values with more than 200 digits (an arbitrary cutoff) using\n         # scientific notation to avoid high memory usage in {:f}'.format().\n         _, digits, exponent = number.as_tuple()\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-31T16:21:53.704101",
  "end_time": "2026-01-31T16:28:16.774208",
  "duration_seconds": 383.070107,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "5d547087-3aa1-4ead-9595-25d8d2289432",
      "epic_title": "Fix: django__django-11206",
      "comment_id": "4e950f93-0ae4-426c-9568-6ff360608019",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nFixed the issue where `django.utils.numberformat.format` was rendering small decimals in exponential notation when `decimal_pos` was provided. The fix ensures that when a number is too small to be represented with the given number of decimal positions, it returns \"0.00...0\" instead of scientific notation.\n\n## Root Cause\n\nThe code had a hardcoded cutoff at 200 digits where numbers would be formatted in scientific notation to avoid high memory usage. This affected even cases where `decimal_pos` was explicitly provided, causing inconsistent behavior:\n- `nformat(Decimal('1e-199'), '.', decimal_pos=2)` returned `'0.00'` \u2713\n- `nformat(Decimal('1e-200'), '.', decimal_pos=2)` returned `'1.00e-200'` \u2717 (should be `'0.00'`)\n\n## Files Modified\n\n- `django/utils/numberformat.py` (lines 30-35): Added logic to convert numbers smaller than the cutoff value (e.g., 0.01 for decimal_pos=2) to zero before the scientific notation check. Used `Decimal(0).copy_sign(number)` to preserve negative signs.\n- `tests/utils_tests/test_numberformat.py` (line 97): Updated test expectation from `'1.234e-300'` to `'0.000'` to match the correct behavior (this test was validating buggy behavior).\n\n## Test Results\n\n- **Test file:** `/testbed/tests/utils_tests/test_numberformat.py`\n- **Baseline (before fix):** 6 passed\n- **After fix:** 6 passed (1 test expectation updated to validate correct behavior)\n\n## Additional Verification\n\nVerified the following edge cases:\n- Very small numbers (1e-199, 1e-200, 1e-300) with various decimal_pos values\n- Boundary cases where number equals the cutoff value\n- Negative very small numbers (sign preservation)\n- Normal numbers (no regression)\n- Very large numbers with scientific notation (still work as expected)\n- Numbers without decimal_pos (still use scientific notation)",
      "created_at": "2026-01-31T15:28:03.844Z"
    }
  ]
}