{
  "instance_id": "pydata__xarray-6992",
  "status": "completed",
  "patch": "diff --git a/xarray/core/dataset.py b/xarray/core/dataset.py\nindex 620f32f8..441c1698 100644\n--- a/xarray/core/dataset.py\n+++ b/xarray/core/dataset.py\n@@ -4177,7 +4177,7 @@ class Dataset(\n         }\n         variables.update(new_variables)\n \n-        coord_names = set(new_variables) | self._coord_names\n+        coord_names = (set(new_variables) | self._coord_names) - set(drop_variables)\n \n         return self._replace(variables, coord_names=coord_names, indexes=indexes)\n \n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-31T17:27:59.997042",
  "end_time": "2026-01-31T17:31:30.110995",
  "duration_seconds": 210.113953,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "a0415841-f470-4a74-8ef9-88634bbe63a5",
      "epic_title": "Fix: pydata__xarray-6992",
      "comment_id": "3e4a6c1d-f668-44d9-8837-ad3df2389fa8",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nFixed bug in `Dataset.reset_index()` where dropped coordinates were not being removed from `_coord_names`, causing a mismatch with `_variables` and resulting in `ValueError: __len__() should return >= 0` when calling `repr()`.\n\nThe issue was at line 4180 in `xarray/core/dataset.py`. When `drop=True`, the dropped coordinate name was removed from `_variables` but not from `_coord_names`. The fix subtracts `drop_variables` (which contains the names to drop) from the new `coord_names` set.\n\n## Files Modified\n- `xarray/core/dataset.py`: Changed line 4180 from `coord_names = set(new_variables) | self._coord_names` to `coord_names = (set(new_variables) | self._coord_names) - set(drop_variables)`\n\n## Test Results\n- **Test file:** xarray/tests/test_dataset.py\n- **Baseline (before fix):** 370 passed, 1 skipped, 1 xfailed, 1 xpassed\n- **After fix:** 370 passed, 1 skipped, 1 xfailed, 1 xpassed\n- **Regression check:** No new failures introduced\n\n## Additional Verification\n- Original MVCE now works without error:\n  ```python\n  ds = xr.Dataset(coords={\"a\": (\"x\", [1, 2, 3]), \"b\": (\"x\", ['a', 'b', 'c'])})\n  ds.set_index(z=['a', 'b']).reset_index(\"z\", drop=True)  # No more ValueError\n  ```\n- All index-related tests (60 tests) pass\n- Both Dataset and DataArray reset_index tests pass\n\n## Concerns\nNone. The fix is minimal and focused on the root cause.",
      "created_at": "2026-01-31T16:31:17.177Z"
    }
  ]
}