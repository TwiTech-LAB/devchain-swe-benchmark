{
  "instance_id": "django__django-15252",
  "status": "completed",
  "patch": "diff --git a/django/db/migrations/recorder.py b/django/db/migrations/recorder.py\nindex 1a37c6b7d0..3caaf467e7 100644\n--- a/django/db/migrations/recorder.py\n+++ b/django/db/migrations/recorder.py\n@@ -1,5 +1,5 @@\n from django.apps.registry import Apps\n-from django.db import DatabaseError, models\n+from django.db import DatabaseError, models, router\n from django.utils.functional import classproperty\n from django.utils.timezone import now\n \n@@ -62,6 +62,9 @@ class MigrationRecorder:\n         # in the codebase.\n         if self.has_table():\n             return\n+        # Check if the router allows migration for the migrations app on this database\n+        if not router.allow_migrate(self.connection.alias, self.Migration._meta.app_label):\n+            return\n         # Make the table\n         try:\n             with self.connection.schema_editor() as editor:\n@@ -84,12 +87,14 @@ class MigrationRecorder:\n     def record_applied(self, app, name):\n         \"\"\"Record that a migration was applied.\"\"\"\n         self.ensure_schema()\n-        self.migration_qs.create(app=app, name=name)\n+        if self.has_table():\n+            self.migration_qs.create(app=app, name=name)\n \n     def record_unapplied(self, app, name):\n         \"\"\"Record that a migration was unapplied.\"\"\"\n         self.ensure_schema()\n-        self.migration_qs.filter(app=app, name=name).delete()\n+        if self.has_table():\n+            self.migration_qs.filter(app=app, name=name).delete()\n \n     def flush(self):\n         \"\"\"Delete all migration records. Useful for testing migrations.\"\"\"\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-31T15:22:32.049874",
  "end_time": "2026-01-31T15:28:34.955736",
  "duration_seconds": 362.905862,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "74e0a021-cfb5-48b7-88a9-b74e7b7608c1",
      "epic_title": "Fix: django__django-15252",
      "comment_id": "b5435984-aae8-4942-8763-f36ededd004c",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nFixed `MigrationRecorder` to respect db_router `allow_migrate` rules. Previously, the `ensure_schema()` method would unconditionally create the `django_migrations` table on all database connections, even when a router disallowed migration.\n\n## Files Modified\n\n- **django/db/migrations/recorder.py**: \n  - Added `router` import from `django.db`\n  - Modified `ensure_schema()` to check `router.allow_migrate()` before creating the table\n  - Modified `record_applied()` and `record_unapplied()` to check if the table exists before attempting to modify records\n\n## Test Results\n\n- **Verification script**: Created and ran a custom test script that verified:\n  - Table is created on databases where `allow_migrate` returns `True`\n  - Table is NOT created on databases where `allow_migrate` returns `False`\n  - `record_applied()` and `record_unapplied()` respect the router\n  - `applied_migrations()` returns empty dict when table doesn't exist\n  \n- **Existing tests**: `tests.migrations.test_executor.ExecutorUnitTests` - all passed\n\n## Edge Cases Handled\n\n- Router returns `False` (migration disallowed) - table is NOT created\n- Router returns `None` (delegates to next router) - default behavior allows migration\n- `record_applied()`/`record_unapplied()` called when router disallows migration - no-op (no table to modify)\n- `applied_migrations()` called when table doesn't exist - returns empty dict (existing behavior preserved)",
      "created_at": "2026-01-31T14:28:15.417Z"
    }
  ]
}