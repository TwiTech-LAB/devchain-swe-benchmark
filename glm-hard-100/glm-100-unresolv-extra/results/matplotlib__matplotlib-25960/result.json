{
  "instance_id": "matplotlib__matplotlib-25960",
  "status": "completed",
  "patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex dab2bc4a5a..14e37ad1a9 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -2274,17 +2274,43 @@ class SubFigure(FigureBase):\n             return\n         # need to figure out *where* this subplotspec is.\n         gs = self._subplotspec.get_gridspec()\n-        wr = np.asarray(gs.get_width_ratios())\n-        hr = np.asarray(gs.get_height_ratios())\n-        dx = wr[self._subplotspec.colspan].sum() / wr.sum()\n-        dy = hr[self._subplotspec.rowspan].sum() / hr.sum()\n-        x0 = wr[:self._subplotspec.colspan.start].sum() / wr.sum()\n-        y0 = 1 - hr[:self._subplotspec.rowspan.stop].sum() / hr.sum()\n+\n+        # Use raw positioning for constrained_layout (no margins/spacing).\n+        # For normal layout, use full positioning including wspace/hspace.\n+        if self.get_constrained_layout():\n+            # Raw positioning: calculate directly from ratios\n+            wr = np.asarray(gs.get_width_ratios())\n+            hr = np.asarray(gs.get_height_ratios())\n+            x0 = wr[:self._subplotspec.colspan.start].sum() / wr.sum()\n+            x1 = wr[:self._subplotspec.colspan.stop].sum() / wr.sum()\n+            y0 = 1 - hr[:self._subplotspec.rowspan.stop].sum() / hr.sum()\n+            y1 = 1 - hr[:self._subplotspec.rowspan.start].sum() / hr.sum()\n+            # These are already in parent's normalized [0,1] space\n+            x0_rel, y0_rel = x0, y0\n+            x1_rel, y1_rel = x1, y1\n+        else:\n+            # Use GridSpec positioning which applies wspace and hspace\n+            bottoms, tops, lefts, rights = gs.get_grid_positions(self.figure)\n+            i = self._subplotspec.colspan.start\n+            j = self._subplotspec.rowspan.start\n+            i2 = self._subplotspec.colspan.stop - 1\n+            j2 = self._subplotspec.rowspan.stop - 1\n+            x0 = lefts[i]\n+            x1 = rights[i2]\n+            y0 = bottoms[j2]\n+            y1 = tops[j]\n+            # Transform from figure coordinates to parent's relative coords\n+            inv = self._parent.transSubfigure.inverted()\n+            bbox_rel = inv.transform([[x0, y0], [x1, y1]])\n+            x0_rel, y0_rel = bbox_rel[0]\n+            x1_rel, y1_rel = bbox_rel[1]\n+\n         if self.bbox_relative is None:\n-            self.bbox_relative = Bbox.from_bounds(x0, y0, dx, dy)\n+            self.bbox_relative = Bbox.from_bounds(x0_rel, y0_rel,\n+                                                   x1_rel - x0_rel, y1_rel - y0_rel)\n         else:\n-            self.bbox_relative.p0 = (x0, y0)\n-            self.bbox_relative.p1 = (x0 + dx, y0 + dy)\n+            self.bbox_relative.p0 = (x0_rel, y0_rel)\n+            self.bbox_relative.p1 = (x1_rel, y1_rel)\n \n     def get_constrained_layout(self):\n         \"\"\"\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-31T19:11:36.114046",
  "end_time": "2026-01-31T19:18:51.298043",
  "duration_seconds": 435.183997,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "bcecc144-145b-48ed-93a4-3002bb9eb6bf",
      "epic_title": "Fix: matplotlib__matplotlib-25960",
      "comment_id": "363c8d87-d903-4fb8-895b-46529c53f432",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nFixed bug where `wspace` and `hspace` parameters in `Figure.subfigures()` were being ignored.\n\n**Root Cause:** The `SubFigure._redo_transform_rel_fig()` method was manually calculating bounding box positions from width/height ratios only, without using the GridSpec's positioning logic that applies wspace and hspace.\n\n**Fix:** Modified `_redo_transform_rel_fig()` in `lib/matplotlib/figure.py` to:\n1. For constrained_layout: Continue using raw positioning (no margins/spacing) to preserve backward compatibility\n2. For normal layout: Use `GridSpec.get_grid_positions()` which properly applies wspace and hspace parameters\n\n## Files Modified\n- `lib/matplotlib/figure.py`: Updated `SubFigure._redo_transform_rel_fig()` to use GridSpec positioning when not using constrained_layout\n\n## Test Results\n- **Test file:** `lib/matplotlib/tests/test_figure.py`\n- **Baseline:** 137 passed, 7 skipped\n- **After fix:** 136 passed, 7 skipped, 1 failed (image comparison)\n- **Failed test:** `test_subfigure_scatter_size` - Image comparison test failure expected because the layout now correctly applies wspace/hspace\n\n## Additional Verification\nTested the original bug report code:\n```python\nimport matplotlib.pyplot as plt\nfigs = plt.figure().subfigures(2, 2, wspace=0.5, hspace=0.5)\n```\n- With wspace=0.5, hspace=0.5: Horizontal gap ~0.155, Vertical gap ~0.154 \u2713\n- With wspace=0, hspace=0: Horizontal gap 0.000, Vertical gap 0.000 \u2713\n\n## Concerns\n- One image comparison test (`test_subfigure_scatter_size`) fails because the layout is now different (correctly applying spacing). This test image would need regeneration with the new correct layout.",
      "created_at": "2026-01-31T18:18:34.754Z"
    }
  ]
}