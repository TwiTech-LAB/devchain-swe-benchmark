{
  "instance_id": "django__django-16263",
  "status": "completed",
  "patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 9735ce10c8..2a8806451e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -545,11 +545,67 @@ class Query(BaseExpression):\n \n         return dict(zip(outer_query.annotation_select, result))\n \n+    def _get_referenced_annotations(self, expression, annotations, exclude_self=None):\n+        \"\"\"\n+        Return a set of annotation aliases referenced by the given expression.\n+        If exclude_self is provided, don't count self-references to that annotation.\n+        \"\"\"\n+        references = set()\n+        if expression is None:\n+            return references\n+        # If this is a Ref, it directly references an annotation\n+        if isinstance(expression, Ref):\n+            references.add(expression.refs)\n+        # If this is an F expression, check if it references an annotation\n+        elif isinstance(expression, F):\n+            if expression.name in annotations:\n+                references.add(expression.name)\n+        # Check if the expression itself is an annotation (e.g., when used in filters)\n+        elif expression in annotations.values():\n+            # Find the annotation name by expression identity\n+            for alias, annotation in annotations.items():\n+                if annotation is expression:\n+                    # Only count as referenced if not excluding self\n+                    if alias != exclude_self:\n+                        references.add(alias)\n+                    break\n+        # Traverse source expressions to find nested references\n+        if hasattr(expression, \"get_source_expressions\"):\n+            for source in expression.get_source_expressions():\n+                references.update(self._get_referenced_annotations(source, annotations, exclude_self))\n+        return references\n+\n     def get_count(self, using):\n         \"\"\"\n         Perform a COUNT() query using the current filter constraints.\n         \"\"\"\n         obj = self.clone()\n+        # Find annotations that are referenced by filters, ordering, or other annotations.\n+        referenced_annotations = set()\n+        # Check annotations referenced in the where clause (filters).\n+        for child in self.where.children:\n+            referenced_annotations.update(\n+                self._get_referenced_annotations(child, self.annotations)\n+            )\n+        # Check annotations referenced in ordering.\n+        for item in self.order_by:\n+            if isinstance(item, str) and item.lstrip(\"-\") in self.annotations:\n+                referenced_annotations.add(item.lstrip(\"-\"))\n+            elif hasattr(item, \"resolve_expression\"):\n+                referenced_annotations.update(\n+                    self._get_referenced_annotations(item, self.annotations)\n+                )\n+        # Check annotations referenced in other annotations.\n+        for alias, annotation in self.annotations.items():\n+            for ref in self._get_referenced_annotations(annotation, self.annotations, exclude_self=alias):\n+                referenced_annotations.add(ref)\n+        # Remove unreferenced annotations.\n+        for alias in list(obj.annotations.keys()):\n+            if alias not in referenced_annotations:\n+                del obj.annotations[alias]\n+                if obj.annotation_select_mask and alias in obj.annotation_select_mask:\n+                    obj.annotation_select_mask.remove(alias)\n+        obj._annotation_select_cache = None\n         obj.add_annotation(Count(\"*\"), alias=\"__count\", is_summary=True)\n         return obj.get_aggregation(using, [\"__count\"])[\"__count\"]\n \ndiff --git a/test_settings.py b/test_settings.py\nnew file mode 100644\nindex 0000000000..37e29fea5f\n--- /dev/null\n+++ b/test_settings.py\n@@ -0,0 +1,9 @@\n+\n+DATABASES = {\n+    'default': {\n+        'ENGINE': 'django.db.backends.sqlite3',\n+        'NAME': ':memory:',\n+    }\n+}\n+INSTALLED_APPS = []\n+SECRET_KEY = 'test'\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-02-03T01:30:09.908871",
  "end_time": "2026-02-03T01:50:33.267573",
  "duration_seconds": 1223.358702,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "a4993681-0efa-431b-98b9-e795f7021b83",
      "epic_title": "Fix: django__django-16263",
      "comment_id": "06273cac-48ab-4248-8f7d-046a894a4733",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nImplemented the optimization to strip unused annotations from count queries. When `QuerySet.count()` is called, annotations that are not referenced by filters, other annotations, or ordering are now removed from the query before execution.\n\n**Implementation Details:**\n\n1. Added `_get_referenced_annotations()` helper method that:\n   - Traverses expressions to find all annotation references\n   - Handles `Ref` objects (direct annotation references)\n   - Handles `F` expressions that reference annotations by name\n   - Detects when annotations are used directly in filters (by expression identity)\n   - Supports nested expressions by traversing source expressions\n\n2. Modified `get_count()` method to:\n   - Find all annotations referenced by filters (where clause)\n   - Find all annotations referenced by ordering\n   - Find all annotations referenced by other annotations\n   - Remove unreferenced annotations from the cloned query\n   - Also clean up the annotation_select_mask\n\n**Files Modified:**\n- `django/db/models/sql/query.py`: Added `_get_referenced_annotations()` method and modified `get_count()` method\n\n## Test Results\n\nAll tests pass, including:\n- Unreferenced annotations are correctly stripped\n- Annotations referenced in filters are kept\n- Annotations referenced in ordering are kept\n- Annotations referenced in other annotations are kept\n- Multiple annotations with mixed references are handled correctly\n- Existing test `test_empty_filter_count` still passes\n\n## Edge Cases Tested\n\n- Empty queries with count()\n- Count with no annotations\n- Multiple unreferenced annotations\n- Complex filters with Q objects\n- Annotation chains (annotation referencing annotation)\n- Annotations used in both filter and another annotation",
      "created_at": "2026-02-03T00:46:38.664Z"
    },
    {
      "epic_id": "a4993681-0efa-431b-98b9-e795f7021b83",
      "epic_title": "Fix: django__django-16263",
      "comment_id": "218febc2-fa07-49b3-9b1c-4ddc4d08fa0c",
      "author_name": "Code Reviewer",
      "content": "Code review PASSED.\n\n- Change is focused (only `django/db/models/sql/query.py`) and doesn\u2019t modify tests.\n- `Query.get_count()` now prunes unreferenced annotations before adding the COUNT aggregate, which aligns with the issue report (`annotate(...).count()` shouldn\u2019t carry unused annotations).\n\nNote: Workspace has an untracked `test_settings.py`; not part of the patch, but worth cleaning up before final submission to avoid confusion.",
      "created_at": "2026-02-03T00:50:26.375Z"
    }
  ]
}