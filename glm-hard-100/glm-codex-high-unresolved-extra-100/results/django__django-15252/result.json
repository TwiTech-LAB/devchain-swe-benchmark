{
  "instance_id": "django__django-15252",
  "status": "completed",
  "patch": "diff --git a/django/db/migrations/recorder.py b/django/db/migrations/recorder.py\nindex 1a37c6b7d0..0adc655ff9 100644\n--- a/django/db/migrations/recorder.py\n+++ b/django/db/migrations/recorder.py\n@@ -1,5 +1,5 @@\n from django.apps.registry import Apps\n-from django.db import DatabaseError, models\n+from django.db import DatabaseError, models, router\n from django.utils.functional import classproperty\n from django.utils.timezone import now\n \n@@ -62,6 +62,12 @@ class MigrationRecorder:\n         # in the codebase.\n         if self.has_table():\n             return\n+        # Check if migrations are allowed for this database\n+        if not router.allow_migrate(\n+            self.connection.alias,\n+            self.Migration._meta.app_label,\n+        ):\n+            return\n         # Make the table\n         try:\n             with self.connection.schema_editor() as editor:\n@@ -83,11 +89,23 @@ class MigrationRecorder:\n \n     def record_applied(self, app, name):\n         \"\"\"Record that a migration was applied.\"\"\"\n+        # If migrations are not allowed for this database, do nothing.\n+        if not router.allow_migrate(\n+            self.connection.alias,\n+            self.Migration._meta.app_label,\n+        ):\n+            return\n         self.ensure_schema()\n         self.migration_qs.create(app=app, name=name)\n \n     def record_unapplied(self, app, name):\n         \"\"\"Record that a migration was unapplied.\"\"\"\n+        # If migrations are not allowed for this database, do nothing.\n+        if not router.allow_migrate(\n+            self.connection.alias,\n+            self.Migration._meta.app_label,\n+        ):\n+            return\n         self.ensure_schema()\n         self.migration_qs.filter(app=app, name=name).delete()\n \n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-02-03T00:49:44.789279",
  "end_time": "2026-02-03T00:56:29.304495",
  "duration_seconds": 404.515216,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "b45880d0-e920-46af-aa22-9c64c8da29c7",
      "epic_title": "Fix: django__django-15252",
      "comment_id": "4289a1f2-0aae-4ed3-a099-7fb6594b8941",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nFixed MigrationRecorder to respect db_router `allow_migrate` rules. Previously, the `ensure_schema()`, `record_applied()`, and `record_unapplied()` methods would create/modify the django_migrations table on databases even when the router's `allow_migrate()` returned False.\n\n## Files Modified\n- `django/db/migrations/recorder.py`: Added router checks in `ensure_schema()`, `record_applied()`, and `record_unapplied()` methods\n\n## Changes Made\n1. Added import of `router` from `django.db`\n2. Added router check in `ensure_schema()` - returns early without creating table if migrations are not allowed\n3. Added router check in `record_applied()` - returns early without recording if migrations are not allowed\n4. Added router check in `record_unapplied()` - returns early without recording if migrations are not allowed\n\n## Test Results\nCreated and ran comprehensive tests to verify:\n- Table is NOT created on databases where router returns False\n- Table IS created on databases where router returns True\n- Table IS created when router returns None (default behavior)\n- `record_applied()` and `record_unapplied()` respect the router and do nothing when migrations are not allowed\n\nAll tests passed successfully.\n\n## Edge Cases Considered\n- Router returns False (migrations disallowed) - methods return early without creating tables or records\n- Router returns True (migrations allowed) - methods proceed normally\n- Router returns None (no opinion) - default behavior allows migrations (returns True from router.allow_migrate)",
      "created_at": "2026-02-02T23:54:46.901Z"
    },
    {
      "epic_id": "b45880d0-e920-46af-aa22-9c64c8da29c7",
      "epic_title": "Fix: django__django-15252",
      "comment_id": "5d61ab95-8a8f-48e3-9469-73ab343e66cf",
      "author_name": "Code Reviewer",
      "content": "Code review PASSED.\n\n- Scope is minimal: only `django/db/migrations/recorder.py` changed; no tests/config touched.\n- The fix directly addresses the issue by checking `router.allow_migrate()` before creating or writing to `django_migrations` on a given connection.\n\nNote (non-blocking): the router check is based on the `migrations` app_label; this matches Django\u2019s router API and is sufficient for the reported multi-db \u201cdefault only\u201d use case.",
      "created_at": "2026-02-02T23:56:18.012Z"
    }
  ]
}