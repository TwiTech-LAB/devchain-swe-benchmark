{
  "instance_id": "django__django-16560",
  "status": "completed",
  "patch": "diff --git a/django/contrib/postgres/constraints.py b/django/contrib/postgres/constraints.py\nindex ad3a5f61f5..058bb01488 100644\n--- a/django/contrib/postgres/constraints.py\n+++ b/django/contrib/postgres/constraints.py\n@@ -33,6 +33,7 @@ class ExclusionConstraint(BaseConstraint):\n         deferrable=None,\n         include=None,\n         violation_error_message=None,\n+        violation_error_code=None,\n     ):\n         if index_type and index_type.lower() not in {\"gist\", \"spgist\"}:\n             raise ValueError(\n@@ -60,7 +61,11 @@ class ExclusionConstraint(BaseConstraint):\n         self.condition = condition\n         self.deferrable = deferrable\n         self.include = tuple(include) if include else ()\n-        super().__init__(name=name, violation_error_message=violation_error_message)\n+        super().__init__(\n+            name=name,\n+            violation_error_message=violation_error_message,\n+            violation_error_code=violation_error_code,\n+        )\n \n     def _get_expressions(self, schema_editor, query):\n         expressions = []\n@@ -150,11 +155,12 @@ class ExclusionConstraint(BaseConstraint):\n                 and self.deferrable == other.deferrable\n                 and self.include == other.include\n                 and self.violation_error_message == other.violation_error_message\n+                and self.violation_error_code == other.violation_error_code\n             )\n         return super().__eq__(other)\n \n     def __repr__(self):\n-        return \"<%s: index_type=%s expressions=%s name=%s%s%s%s%s>\" % (\n+        return \"<%s: index_type=%s expressions=%s name=%s%s%s%s%s%s>\" % (\n             self.__class__.__qualname__,\n             repr(self.index_type),\n             repr(self.expressions),\n@@ -168,6 +174,11 @@ class ExclusionConstraint(BaseConstraint):\n                 or self.violation_error_message == self.default_violation_error_message\n                 else \" violation_error_message=%r\" % self.violation_error_message\n             ),\n+            (\n+                \"\"\n+                if self.violation_error_code is None\n+                else \" violation_error_code=%r\" % self.violation_error_code\n+            ),\n         )\n \n     def validate(self, model, instance, exclude=None, using=DEFAULT_DB_ALIAS):\n@@ -204,9 +215,15 @@ class ExclusionConstraint(BaseConstraint):\n             queryset = queryset.exclude(pk=model_class_pk)\n         if not self.condition:\n             if queryset.exists():\n-                raise ValidationError(self.get_violation_error_message())\n+                raise ValidationError(\n+                    self.get_violation_error_message(),\n+                    code=self.get_violation_error_code(),\n+                )\n         else:\n             if (self.condition & Exists(queryset.filter(self.condition))).check(\n                 replacement_map, using=using\n             ):\n-                raise ValidationError(self.get_violation_error_message())\n+                raise ValidationError(\n+                    self.get_violation_error_message(),\n+                    code=self.get_violation_error_code(),\n+                )\ndiff --git a/django/db/models/constraints.py b/django/db/models/constraints.py\nindex 075ecee1be..1494867179 100644\n--- a/django/db/models/constraints.py\n+++ b/django/db/models/constraints.py\n@@ -18,11 +18,13 @@ __all__ = [\"BaseConstraint\", \"CheckConstraint\", \"Deferrable\", \"UniqueConstraint\"\n \n class BaseConstraint:\n     default_violation_error_message = _(\"Constraint \u201c%(name)s\u201d is violated.\")\n+    default_violation_error_code = None\n     violation_error_message = None\n+    violation_error_code = None\n \n     # RemovedInDjango60Warning: When the deprecation ends, replace with:\n-    # def __init__(self, *, name, violation_error_message=None):\n-    def __init__(self, *args, name=None, violation_error_message=None):\n+    # def __init__(self, *, name, violation_error_message=None, violation_error_code=None):\n+    def __init__(self, *args, name=None, violation_error_message=None, violation_error_code=None):\n         # RemovedInDjango60Warning.\n         if name is None and not args:\n             raise TypeError(\n@@ -34,6 +36,10 @@ class BaseConstraint:\n             self.violation_error_message = violation_error_message\n         else:\n             self.violation_error_message = self.default_violation_error_message\n+        if violation_error_code is not None:\n+            self.violation_error_code = violation_error_code\n+        else:\n+            self.violation_error_code = self.default_violation_error_code\n         # RemovedInDjango60Warning.\n         if args:\n             warnings.warn(\n@@ -42,7 +48,7 @@ class BaseConstraint:\n                 RemovedInDjango60Warning,\n                 stacklevel=2,\n             )\n-            for arg, attr in zip(args, [\"name\", \"violation_error_message\"]):\n+            for arg, attr in zip(args, [\"name\", \"violation_error_message\", \"violation_error_code\"]):\n                 if arg:\n                     setattr(self, attr, arg)\n \n@@ -65,6 +71,9 @@ class BaseConstraint:\n     def get_violation_error_message(self):\n         return self.violation_error_message % {\"name\": self.name}\n \n+    def get_violation_error_code(self):\n+        return self.violation_error_code\n+\n     def deconstruct(self):\n         path = \"%s.%s\" % (self.__class__.__module__, self.__class__.__name__)\n         path = path.replace(\"django.db.models.constraints\", \"django.db.models\")\n@@ -74,6 +83,8 @@ class BaseConstraint:\n             and self.violation_error_message != self.default_violation_error_message\n         ):\n             kwargs[\"violation_error_message\"] = self.violation_error_message\n+        if self.violation_error_code is not None:\n+            kwargs[\"violation_error_code\"] = self.violation_error_code\n         return (path, (), kwargs)\n \n     def clone(self):\n@@ -82,13 +93,17 @@ class BaseConstraint:\n \n \n class CheckConstraint(BaseConstraint):\n-    def __init__(self, *, check, name, violation_error_message=None):\n+    def __init__(self, *, check, name, violation_error_message=None, violation_error_code=None):\n         self.check = check\n         if not getattr(check, \"conditional\", False):\n             raise TypeError(\n                 \"CheckConstraint.check must be a Q instance or boolean expression.\"\n             )\n-        super().__init__(name=name, violation_error_message=violation_error_message)\n+        super().__init__(\n+            name=name,\n+            violation_error_message=violation_error_message,\n+            violation_error_code=violation_error_code,\n+        )\n \n     def _get_check_sql(self, model, schema_editor):\n         query = Query(model=model, alias_cols=False)\n@@ -112,12 +127,15 @@ class CheckConstraint(BaseConstraint):\n         against = instance._get_field_value_map(meta=model._meta, exclude=exclude)\n         try:\n             if not Q(self.check).check(against, using=using):\n-                raise ValidationError(self.get_violation_error_message())\n+                raise ValidationError(\n+                    self.get_violation_error_message(),\n+                    code=self.get_violation_error_code(),\n+                )\n         except FieldError:\n             pass\n \n     def __repr__(self):\n-        return \"<%s: check=%s name=%s%s>\" % (\n+        return \"<%s: check=%s name=%s%s%s>\" % (\n             self.__class__.__qualname__,\n             self.check,\n             repr(self.name),\n@@ -127,6 +145,11 @@ class CheckConstraint(BaseConstraint):\n                 or self.violation_error_message == self.default_violation_error_message\n                 else \" violation_error_message=%r\" % self.violation_error_message\n             ),\n+            (\n+                \"\"\n+                if self.violation_error_code is None\n+                else \" violation_error_code=%r\" % self.violation_error_code\n+            ),\n         )\n \n     def __eq__(self, other):\n@@ -135,6 +158,7 @@ class CheckConstraint(BaseConstraint):\n                 self.name == other.name\n                 and self.check == other.check\n                 and self.violation_error_message == other.violation_error_message\n+                and self.violation_error_code == other.violation_error_code\n             )\n         return super().__eq__(other)\n \n@@ -164,6 +188,7 @@ class UniqueConstraint(BaseConstraint):\n         include=None,\n         opclasses=(),\n         violation_error_message=None,\n+        violation_error_code=None,\n     ):\n         if not name:\n             raise ValueError(\"A unique constraint must be named.\")\n@@ -213,7 +238,11 @@ class UniqueConstraint(BaseConstraint):\n             F(expression) if isinstance(expression, str) else expression\n             for expression in expressions\n         )\n-        super().__init__(name=name, violation_error_message=violation_error_message)\n+        super().__init__(\n+            name=name,\n+            violation_error_message=violation_error_message,\n+            violation_error_code=violation_error_code,\n+        )\n \n     @property\n     def contains_expressions(self):\n@@ -293,7 +322,7 @@ class UniqueConstraint(BaseConstraint):\n         )\n \n     def __repr__(self):\n-        return \"<%s:%s%s%s%s%s%s%s%s>\" % (\n+        return \"<%s:%s%s%s%s%s%s%s%s%s>\" % (\n             self.__class__.__qualname__,\n             \"\" if not self.fields else \" fields=%s\" % repr(self.fields),\n             \"\" if not self.expressions else \" expressions=%s\" % repr(self.expressions),\n@@ -308,6 +337,11 @@ class UniqueConstraint(BaseConstraint):\n                 or self.violation_error_message == self.default_violation_error_message\n                 else \" violation_error_message=%r\" % self.violation_error_message\n             ),\n+            (\n+                \"\"\n+                if self.violation_error_code is None\n+                else \" violation_error_code=%r\" % self.violation_error_code\n+            ),\n         )\n \n     def __eq__(self, other):\n@@ -321,6 +355,7 @@ class UniqueConstraint(BaseConstraint):\n                 and self.opclasses == other.opclasses\n                 and self.expressions == other.expressions\n                 and self.violation_error_message == other.violation_error_message\n+                and self.violation_error_code == other.violation_error_code\n             )\n         return super().__eq__(other)\n \n@@ -385,7 +420,10 @@ class UniqueConstraint(BaseConstraint):\n         if not self.condition:\n             if queryset.exists():\n                 if self.expressions:\n-                    raise ValidationError(self.get_violation_error_message())\n+                    raise ValidationError(\n+                        self.get_violation_error_message(),\n+                        code=self.get_violation_error_code(),\n+                    )\n                 # When fields are defined, use the unique_error_message() for\n                 # backward compatibility.\n                 for model, constraints in instance.get_constraints():\n@@ -400,6 +438,9 @@ class UniqueConstraint(BaseConstraint):\n                 if (self.condition & Exists(queryset.filter(self.condition))).check(\n                     against, using=using\n                 ):\n-                    raise ValidationError(self.get_violation_error_message())\n+                    raise ValidationError(\n+                        self.get_violation_error_message(),\n+                        code=self.get_violation_error_code(),\n+                    )\n             except FieldError:\n                 pass\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-02-01T06:27:46.047428",
  "end_time": "2026-02-01T06:39:00.238383",
  "duration_seconds": 674.190955,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "1aabe705-4eae-4d5c-b81a-ed6103a9b79b",
      "epic_title": "Fix: django__django-16560",
      "comment_id": "ddfd4ffe-a65b-4021-9ec3-81b8e2db49d2",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nAdded `violation_error_code` parameter to `BaseConstraint` and its subclasses (`CheckConstraint`, `UniqueConstraint`, `ExclusionConstraint`) to allow customization of the error code when a `ValidationError` is raised during constraint validation.\n\nPreviously, users could customize `violation_error_message` but not the error code. This required subclassing constraints and overriding the `validate()` method to catch and re-raise `ValidationError` with a custom code.\n\n## Files Modified\n\n- `django/db/models/constraints.py`:\n  - `BaseConstraint`: Added `default_violation_error_code` (None) and `violation_error_code` attributes, added `violation_error_code` parameter to `__init__`, added `get_violation_error_code()` method, updated `deconstruct()` to serialize the code\n  - `CheckConstraint`: Added `violation_error_code` parameter, updated `validate()` to pass code to `ValidationError`, updated `__repr__()` and `__eq__()`\n  - `UniqueConstraint`: Added `violation_error_code` parameter, updated `validate()` to pass code to `ValidationError`, updated `__repr__()` and `__eq__()`\n\n- `django/contrib/postgres/constraints.py`:\n  - `ExclusionConstraint`: Added `violation_error_code` parameter, updated `validate()` to pass code to `ValidationError`, updated `__repr__()` and `__eq__()`\n\n## Test Results\n- **Test files:** `tests/validation/test_constraints.py`, `tests/postgres_tests/test_constraints.py`\n- **Result:** 7 validation tests passed, 49 postgres tests skipped (no PostgreSQL database)\n- **Regression check:** No new failures introduced\n\n## Example Usage\n\n```python\nfrom django.db import models\nfrom django.db.models import CheckConstraint, Q, UniqueConstraint\n\nclass Person(models.Model):\n    age = models.IntegerField()\n    \n    class Meta:\n        constraints = [\n            CheckConstraint(\n                check=Q(age__gte=18),\n                name='check_adult',\n                violation_error_message='Must be an adult',\n                violation_error_code='underage'  # NEW!\n            ),\n            UniqueConstraint(\n                fields=['email'],\n                name='unique_email',\n                violation_error_code='duplicate_email'  # NEW!\n            ),\n        ]\n```\n\nWhen the constraint is violated, the ValidationError will now include the custom code:\n```python\nValidationError(['Must be an adult'], code='underage')\n```",
      "created_at": "2026-02-01T05:36:31.257Z"
    },
    {
      "epic_id": "1aabe705-4eae-4d5c-b81a-ed6103a9b79b",
      "epic_title": "Fix: django__django-16560",
      "comment_id": "f40b3e01-14a7-4da8-86ff-55d1b99d2e55",
      "author_name": "Code Reviewer",
      "content": "## Code Review: PASSED \u2713\n\nThe fix successfully implements the requested feature to allow customization of the `code` attribute in ValidationError raised by BaseConstraint.\n\n### Verification Results:\n- **Test Execution**: 73 constraint tests passed, 4 skipped (database features)\n- **Regressions**: None detected\n- **Code Quality**: Excellent - follows Django patterns consistently\n\n### Implementation Strengths:\n1. Clean base class design with `default_violation_error_code` and `get_violation_error_code()`\n2. Consistent propagation to all constraint subclasses (CheckConstraint, UniqueConstraint, ExclusionConstraint)\n3. Proper updates to `__repr__`, `__eq__`, and `deconstruct()` methods across all classes\n4. Maintains backward compatibility (defaults to None)\n5. Follows same pattern as existing `violation_error_message` parameter\n6. No test files modified (source code only)\n\n### Files Modified:\n- `django/db/models/constraints.py` \u2713\n- `django/contrib/postgres/constraints.py` \u2713\n\nThe implementation directly addresses the problem statement and provides the exact functionality requested: ability to customize error codes without requiring constraint subclassing.\n\n**Approved for deployment.**",
      "created_at": "2026-02-01T05:38:51.136Z"
    }
  ]
}