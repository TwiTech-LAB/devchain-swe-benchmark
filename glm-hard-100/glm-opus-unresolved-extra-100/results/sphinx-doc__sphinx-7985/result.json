{
  "instance_id": "sphinx-doc__sphinx-7985",
  "status": "completed",
  "patch": "diff --git a/sphinx/builders/linkcheck.py b/sphinx/builders/linkcheck.py\nindex dd5317087..c6cba2c9e 100644\n--- a/sphinx/builders/linkcheck.py\n+++ b/sphinx/builders/linkcheck.py\n@@ -116,6 +116,68 @@ class CheckExternalLinksBuilder(Builder):\n         if self.app.config.linkcheck_timeout:\n             kwargs['timeout'] = self.app.config.linkcheck_timeout\n \n+        def check_local_reference(uri: str, docname: str) -> Tuple[str, str, int]:\n+            \"\"\"Check if a local/internal reference exists.\n+\n+            Returns (status, info, code) tuple where status is one of:\n+            - 'working': reference exists\n+            - 'broken': reference does not exist\n+            \"\"\"\n+            # Get the standard domain which contains all reference labels\n+            std_domain = self.env.get_domain('std')\n+\n+            # Handle anchor-only references (same document)\n+            if uri.startswith('#'):\n+                anchor = uri[1:]\n+                doctree = self.env.get_doctree(docname)\n+                if anchor in doctree.ids:\n+                    return 'working', '', 0\n+                else:\n+                    return 'broken', __('anchor not found: %s') % anchor, 0\n+\n+            # Handle references to labels (same-document or cross-document)\n+            # These are simple names like 'local-link' or 'some-section'\n+            # Check in both named labels and anonymous labels\n+            if uri in std_domain.labels:\n+                # Reference exists - it's a named label with a title\n+                return 'working', '', 0\n+            elif uri in std_domain.anonlabels:\n+                # Reference exists - it's an anonymous label\n+                return 'working', '', 0\n+            elif uri in self.env.all_docs:\n+                # Reference exists - it's a document name\n+                return 'working', '', 0\n+            else:\n+                # Reference might be a combination of docname#anchor or other formats\n+                # Try to parse it\n+                if '#' in uri:\n+                    doc_ref, anchor = uri.split('#', 1)\n+                    # Check if it's docname#anchor format\n+                    if doc_ref in self.env.all_docs:\n+                        doctree = self.env.get_doctree(doc_ref)\n+                        if anchor in doctree.ids:\n+                            return 'working', '', 0\n+                        else:\n+                            return 'broken', __('anchor %r not found in %r') % (anchor, doc_ref), 0\n+                    # Check if it's a label#anchor format (label in a document)\n+                    elif doc_ref in std_domain.labels:\n+                        target_docname, labelid, _ = std_domain.labels[doc_ref]\n+                        doctree = self.env.get_doctree(target_docname)\n+                        if anchor in doctree.ids:\n+                            return 'working', '', 0\n+                        else:\n+                            return 'broken', __('anchor %r not found in %r') % (anchor, target_docname), 0\n+                    elif doc_ref in std_domain.anonlabels:\n+                        target_docname, labelid = std_domain.anonlabels[doc_ref]\n+                        doctree = self.env.get_doctree(target_docname)\n+                        if anchor in doctree.ids:\n+                            return 'working', '', 0\n+                        else:\n+                            return 'broken', __('anchor %r not found in %r') % (anchor, target_docname), 0\n+\n+                # Reference not found\n+                return 'broken', __('local reference not found: %s') % uri, 0\n+\n         def get_request_headers() -> Dict:\n             url = urlparse(uri)\n             candidates = [\"%s://%s\" % (url.scheme, url.netloc),\n@@ -210,10 +272,11 @@ class CheckExternalLinksBuilder(Builder):\n \n         def check() -> Tuple[str, str, int]:\n             # check for various conditions without bothering the network\n-            if len(uri) == 0 or uri.startswith(('#', 'mailto:', 'ftp:')):\n+            if len(uri) == 0 or uri.startswith(('mailto:', 'ftp:')):\n                 return 'unchecked', '', 0\n             elif not uri.startswith(('http:', 'https:')):\n-                return 'local', '', 0\n+                # Check local/internal references\n+                return check_local_reference(uri, docname)\n             elif uri in self.good:\n                 return 'working', 'old', 0\n             elif uri in self.broken:\ndiff --git a/tox.ini b/tox.ini\nindex bddd822a6..34baee205 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -27,7 +27,7 @@ extras =\n setenv =\n     PYTHONWARNINGS = all,ignore::ImportWarning:importlib._bootstrap_external,ignore::DeprecationWarning:site,ignore::DeprecationWarning:distutils\n commands=\n-    pytest --durations 25 {posargs}\n+    pytest -rA --durations 25 {posargs}\n \n [testenv:flake8]\n basepython = python3\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-02-03T15:50:12.520499",
  "end_time": "2026-02-03T16:04:43.209283",
  "duration_seconds": 870.688784,
  "error_message": null,
  "workspace_path": "<redacted>",
  "epic_comments": [
    {
      "epic_id": "75866dfd-dba4-40df-b8da-44d69dfb214a",
      "epic_title": "Fix: sphinx-doc__sphinx-7985",
      "comment_id": "cdebc7f8-7885-47f8-bfb8-f1046162af98",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nImplemented local (internal) link checking in the linkcheck builder. Previously, local links (like `.. _local-link: doesntexist`) were simply marked with `-local-` and not validated. Now they are properly checked against the Sphinx environment's reference data structures.\n\n## Files Modified\n\n- `sphinx/builders/linkcheck.py`: Added `check_local_reference()` function that checks if local references exist in:\n  - `env.domains['std'].labels` (named labels)\n  - `env.domains['std'].anonlabels` (anonymous labels)  \n  - `env.all_docs` (document names)\n  - Document doctrees (for anchor validation)\n\nThe `check()` function now calls `check_local_reference()` for local URIs instead of returning a generic 'local' status.\n\n## Test Results\n\n- **Test file:** tests/test_build_linkcheck.py\n- **Baseline (before fix):** 5 passed, 0 failed, 0 errors\n- **After fix:** 5 passed, 0 failed, 0 errors\n- **Regression check:** No new failures introduced\n\n## Additional Verification\n\nCreated test documents with various scenarios:\n1. Broken local link (`doesntexist`) - correctly detected as broken\n2. Valid local links (labels, anchors, documents) - correctly detected as working\n3. The exact scenario from the issue (both external and local broken links) - both correctly detected as broken\n\nExample output for the issue's test case:\n```\n(line    4) broken    doesntexist - local reference not found: doesntexist\n(line    4) broken    https://lkfqhlkghflkhs - HTTPSConnectionPool...\n```\n\n## Concerns\n\n- The implementation handles edge cases including:\n  - Empty URIs (treated as 'unchecked')\n  - Anchor-only references (like `#section`)\n  - Cross-document references (like `otherdoc` or `otherdoc#section`)\n  - Label references with anchors (like `labelname#anchor`)\n\n- The 'local' status case in `process_result()` is now dead code since we no longer return 'local' status. This is left for backward compatibility but could be removed in a future cleanup.",
      "created_at": "2026-02-03T15:01:51.543Z"
    },
    {
      "epic_id": "75866dfd-dba4-40df-b8da-44d69dfb214a",
      "epic_title": "Fix: sphinx-doc__sphinx-7985",
      "comment_id": "9c1176d7-0b55-4315-8518-40d382f03285",
      "author_name": "Code Reviewer",
      "content": "Code Review PASSED\n\n**Summary:** The fix correctly addresses the problem statement. Local (internal) links are now validated instead of being silently skipped with `-local-` status.\n\n**What was reviewed:**\n- `sphinx/builders/linkcheck.py` \u2014 new `check_local_reference()` function and routing change in `check()`\n- `setup.py`, `tox.ini` \u2014 build config changes (auto-excluded from final patch, ignored)\n\n**Checklist:**\n- \u2705 No test files modified\n- \u2705 No unrelated source files modified\n- \u2705 Fix logically addresses the problem: local URIs are now validated against `std_domain.labels`, `std_domain.anonlabels`, `self.env.all_docs`, and doctree IDs\n- \u2705 No obvious crash bugs: all imports present (`__`, `Tuple`), safe URI parsing with `#` guard, proper scope access to `self.env`\n- \u2705 Changes are minimal and focused: one new nested function + two-line routing change in `check()`\n\n**Notes (non-blocking):**\n- The `'local'` status branch in `process_result()` (line 333) is now dead code. Harmless, but could be cleaned up in a future pass.\n- The fix runs `self.env.get_doctree()` in worker threads, which is consistent with existing thread architecture \u2014 not a new concern.",
      "created_at": "2026-02-03T15:04:35.667Z"
    }
  ]
}