{
  "instance_id": "django__django-15916",
  "status": "completed",
  "patch": "diff --git a/django/forms/models.py b/django/forms/models.py\nindex 192d9fad94..7d56f6a524 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -253,17 +253,25 @@ class ModelFormOptions:\n         self.help_texts = getattr(options, \"help_texts\", None)\n         self.error_messages = getattr(options, \"error_messages\", None)\n         self.field_classes = getattr(options, \"field_classes\", None)\n+        self.formfield_callback = getattr(options, \"formfield_callback\", None)\n \n \n class ModelFormMetaclass(DeclarativeFieldsMetaclass):\n     def __new__(mcs, name, bases, attrs):\n-        base_formfield_callback = None\n-        for b in bases:\n-            if hasattr(b, \"Meta\") and hasattr(b.Meta, \"formfield_callback\"):\n-                base_formfield_callback = b.Meta.formfield_callback\n-                break\n+        # Collect formfield_callback with proper precedence:\n+        # 1. Explicit class-level formfield_callback attribute (highest priority)\n+        formfield_callback = attrs.pop(\"formfield_callback\", None)\n \n-        formfield_callback = attrs.pop(\"formfield_callback\", base_formfield_callback)\n+        # 2. formfield_callback defined in the current class's Meta\n+        if formfield_callback is None and \"Meta\" in attrs:\n+            formfield_callback = getattr(attrs[\"Meta\"], \"formfield_callback\", None)\n+\n+        # 3. Fallback to formfield_callback from a parent class's Meta\n+        if formfield_callback is None:\n+            for b in bases:\n+                if hasattr(b, \"Meta\") and hasattr(b.Meta, \"formfield_callback\"):\n+                    formfield_callback = b.Meta.formfield_callback\n+                    break\n \n         new_class = super().__new__(mcs, name, bases, attrs)\n \n@@ -636,7 +644,9 @@ def modelform_factory(\n     class_name = model.__name__ + \"Form\"\n \n     # Class attributes for the new form class.\n-    form_class_attrs = {\"Meta\": Meta, \"formfield_callback\": formfield_callback}\n+    form_class_attrs = {\"Meta\": Meta}\n+    if formfield_callback is not None:\n+        form_class_attrs[\"formfield_callback\"] = formfield_callback\n \n     if getattr(Meta, \"fields\", None) is None and getattr(Meta, \"exclude\", None) is None:\n         raise ImproperlyConfigured(\n",
  "epics_created": 1,
  "epics_completed": 1,
  "start_time": "2026-01-16T12:51:39.592519",
  "end_time": "2026-01-16T13:03:03.515866",
  "duration_seconds": 683.923347,
  "error_message": null,
  "workspace_path": "./workspaces/django__django-15916",
  "epic_comments": [
    {
      "epic_id": "a550c9e2-be82-4ef3-870a-d91b666a9ce3",
      "epic_title": "Fix: django__django-15916",
      "comment_id": "64fb4f6f-a081-4a8d-86d7-3aff506a9c47",
      "author_name": "Brainstormer",
      "content": "## Fix Summary\n\nImplemented support for `formfield_callback` in ModelForm's Meta class. The fix ensures that:\n\n1. When `modelform_factory()` is called without an explicit `formfield_callback`, it now correctly inherits the callback from the base form's `Meta.formfield_callback` if defined.\n\n2. When defining a ModelForm directly with `Meta.formfield_callback`, the callback is now properly used (previously only class-level `formfield_callback` worked).\n\n**Root Cause:** The `modelform_factory` function was always setting `formfield_callback` in the class attrs dict, even when it was `None`. This caused the metaclass to use `None` instead of inheriting from the parent form's Meta.\n\n## Files Modified\n\n- **django/forms/models.py**:\n  - `ModelFormOptions.__init__`: Added `self.formfield_callback = getattr(options, \"formfield_callback\", None)` for consistency with other Meta options\n  - `ModelFormMetaclass.__new__`: Added check for current class's `Meta.formfield_callback` when `formfield_callback` is not set via attrs or parent classes\n  - `modelform_factory`: Changed to only add `formfield_callback` to `form_class_attrs` when it's not `None`, allowing the metaclass inheritance to work properly\n\n## Test Results\n\n- **Test file:** tests/model_forms/tests.py and tests/model_formsets/tests.py\n- **Baseline (before fix):** 251 passed, 0 failed, 0 errors\n- **After fix:** 251 passed, 0 failed, 0 errors\n- **Regression check:** No new failures introduced\n\n## Additional Verification\n\nCreated a comprehensive test script that verified:\n1. Direct ModelForm with `Meta.formfield_callback` now works correctly\n2. `modelform_factory(form=MyForm)` correctly inherits `Meta.formfield_callback`\n3. Explicit `formfield_callback` parameter still works\n4. Forms without callbacks behave as before\n5. `_meta.formfield_callback` is now accessible\n\n## Concerns\n\n- None - the fix is minimal and focused, maintaining backward compatibility while adding the requested feature.",
      "created_at": "2026-01-16T11:55:43.071Z"
    },
    {
      "epic_id": "a550c9e2-be82-4ef3-870a-d91b666a9ce3",
      "epic_title": "Fix: django__django-15916",
      "comment_id": "edd50f95-f26a-4d01-a0c5-fb7198e3f5b6",
      "author_name": "Code Reviewer",
      "content": "Code Review FAILED\n\nIssues Found:\n- `ModelFormMetaclass.__new__()` currently prefers the first base class\u2019 `Meta.formfield_callback` over the current class\u2019 `Meta.formfield_callback`.\n  - Example: if `ParentForm.Meta.formfield_callback = cb1` and `ChildForm.Meta.formfield_callback = cb2`, the current logic sets `formfield_callback` to `cb1` (from bases) and never consults `ChildForm.Meta.formfield_callback` because the check only runs when the callback is `None`.\n  - This makes overriding `formfield_callback` via `Meta` inconsistent with other `ModelFormOptions` (where the current class\u2019 `Meta` should take precedence).\n\nRequired Changes:\n- Adjust callback resolution precedence so it behaves like other `Meta` options:\n  - explicit `formfield_callback` in class attrs (or factory kwarg) should win;\n  - otherwise, use the *current class\u2019* `Meta.formfield_callback` if present;\n  - otherwise fall back to inherited/base `Meta.formfield_callback`.\n- Consider using `opts.formfield_callback` (now populated by `ModelFormOptions`) when calling `fields_for_model()`, or otherwise ensure the resolved callback matches `new_class.Meta.formfield_callback` when explicitly set on the current class.\n\nNotes:\n- No test files/build configs were modified; changes are minimal and localized to `django/forms/models.py`.",
      "created_at": "2026-01-16T11:58:55.021Z"
    },
    {
      "epic_id": "a550c9e2-be82-4ef3-870a-d91b666a9ce3",
      "epic_title": "Fix: django__django-15916",
      "comment_id": "68217222-5d78-4698-b1e3-20f3c940f1f3",
      "author_name": "Brainstormer",
      "content": "## Fix for Precedence Issue\n\nUpdated `ModelFormMetaclass.__new__` to properly handle callback precedence:\n\n**New precedence order (highest to lowest):**\n1. Explicit class-level `formfield_callback` attribute\n2. Current class's `Meta.formfield_callback`\n3. Parent class's `Meta.formfield_callback` (fallback)\n\n**Change made:**\n```python\n# OLD (incorrect - parent's Meta wins over current class's Meta):\nbase_formfield_callback = None\nfor b in bases:\n    if hasattr(b, \"Meta\") and hasattr(b.Meta, \"formfield_callback\"):\n        base_formfield_callback = b.Meta.formfield_callback\n        break\nformfield_callback = attrs.pop(\"formfield_callback\", base_formfield_callback)\nif formfield_callback is None and \"Meta\" in attrs:\n    formfield_callback = getattr(attrs[\"Meta\"], \"formfield_callback\", None)\n\n# NEW (correct - current class's Meta wins over parent's):\nformfield_callback = attrs.pop(\"formfield_callback\", None)\nif formfield_callback is None and \"Meta\" in attrs:\n    formfield_callback = getattr(attrs[\"Meta\"], \"formfield_callback\", None)\nif formfield_callback is None:\n    for b in bases:\n        if hasattr(b, \"Meta\") and hasattr(b.Meta, \"formfield_callback\"):\n            formfield_callback = b.Meta.formfield_callback\n            break\n```\n\n## Test Results\n- **model_forms + model_formsets:** 251 passed, 0 failed\n- **Precedence tests:** All 5 scenarios pass:\n  1. Child Meta overrides Parent Meta \u2713\n  2. Explicit class-level callback takes priority \u2713\n  3. modelform_factory inherits from base form's Meta \u2713\n  4. modelform_factory explicit callback overrides Meta \u2713\n  5. Factory with child form uses child's Meta \u2713",
      "created_at": "2026-01-16T12:00:31.992Z"
    },
    {
      "epic_id": "a550c9e2-be82-4ef3-870a-d91b666a9ce3",
      "epic_title": "Fix: django__django-15916",
      "comment_id": "a2595a2b-26a3-49f6-9676-d80d8775b6d2",
      "author_name": "Code Reviewer",
      "content": "Code review PASSED.\n\n- The updated `ModelFormMetaclass.__new__()` now applies the expected precedence: explicit class attr > current `Meta.formfield_callback` > inherited/base `Meta.formfield_callback`.\n- `modelform_factory()` no longer injects `formfield_callback=None` into the generated class attrs, so base `Meta.formfield_callback` can be inherited as intended.\n- Only source file `django/forms/models.py` was modified; no tests/build configs were changed.\n- Verification notes include running the actual `model_forms` + `model_formsets` tests (251 passed).",
      "created_at": "2026-01-16T12:02:53.767Z"
    }
  ]
}